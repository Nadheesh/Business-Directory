{% extends 'BDBundle::base.html.twig' %}

{% block otherstylesheets %}
    {#<link rel="stylesheet" href="{{ asset('bundles/bd/css/profileView.css') }}"/>#}

    {#rating style#}
    <link href="{{ asset('bundles/bd/kartik-v/bootstrap-star-rating/css/star-rating.css')}}" media="all" rel="stylesheet" type="text/css" />

    <link href="{{ asset('bundles/bd/kartik-v/bootstrap-star-rating/css/theme-krajee-svg.css') }}" media="all" rel="stylesheet" type="text/css" />
    <link href="{{ asset('bundles/bd/kartik-v/bootstrap-star-rating/css/theme-krajee-uni.css') }}" media="all" rel="stylesheet" type="text/css" />
    <link href="{{ asset('bundles/bd/kartik-v/bootstrap-star-rating/css/theme-krajee-fa.css') }}" media="all" rel="stylesheet" type="text/css" />



    {#jquery ui#}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/theme.min.css" rel="stylesheet">

    {#gmap script#}
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script src="{{ asset('bundles/bd/gmap/js/gmaps.min.js') }}" type="text/javascript" ></script>

    {#rating script#}
    <script src="{{ asset('bundles/bd/kartik-v/bootstrap-star-rating/js/star-rating.js') }}" type="text/javascript"></script>

    {#jquery ui#}
    <script src="{{ asset('bundles/bd/js/jquery-ui.js') }}"></script>

    {#read more#}
    <script src="{{ asset('bundles/bd/readmore/js/readmore.min.js') }}"></script>



{% endblock %}


{% block body %}

    <div id="overlay">
        <div id="animate">
            <h3>Load</h3>
        </div>
    </div>
    {% if company is not empty %}
        <div class="container">
            {#company header#}

            <div class="container section-container">

                <div id="main-section" class="row inner-box-c" style="background:transparent; padding-bottom: 10px">
                    <div class="col-lg-2  col-md-2 col-sm-5 col-xs-5">
                        {% if company.profileUrl is empty %}
                            <div class="profile-pic" style="background: url('{{ asset('bundles/bd/images/placeholder/placeholder-1.jpg') }}')"></div>
                        {% else %}
                            <div class="profile-pic" style="background: url('{{ company.profileUrl }}')" ></div>
                        {% endif %}
                    </div>

                    <div class="col-lg-6  col-md-6 col-sm-7 col-xs-7" >
                        <div class="container-fluid">

                            {#brand name#}
                            <h1 class="text-left">{{ company.companyName}}</h1>
                            <h4 class="text-left">{{ company.companyName }} </h4>
                            <h4 class="text-left">Headquarters : {{ company.address.city }}, {{ company.address.country }}</h4>
                            <h4 class="text-left"> Since&nbsp;{{  company.startDate|date('Y') }} </h4>
                            <h5 class="text-left">{{ company.businessType }}</h5>
                            <p>Website : <a class="text-left" href="{{ company.url }}">{{ company.url }}</a></p>
                            <p>E-mail - {{ company.contactEmail }}</p>

                        </div>

                    </div>

                    {#third column -rating display#}
                    <div id = "rating-col" class="col-lg-4 col-md-4  col-sm-12 col-xs-12">
                        <div class="container-fluid">

                            {#rating summery#}
                            <div class="row">
                                <div class="col-lg-5  col-md-5 col-sm-5 col-xs-5">
                                    <div >
                                        <h1 class="total-rate">0</h1>
                                    </div>
                                </div>
                                <div class="col-lg-5  col-md-5 col-sm-5 col-xs-5" style="color: #aaa; margin-top: 20px">

                                    {#display star rating#}
                                    <div class="row">
                                        <input id="display_rating" type="text" data-size="xs" >
                                    </div>

                                    {#display user count#}
                                    <div class="row">
                                        <p class="user-count"><span class="glyphicon glyphicon-user "></span> {{ company.commentCount }}</p>
                                    </div>
                                </div>
                            </div>

                            {#user count vs # of stars#}
                            {#<div class="row">#}

                            {#<div class="progress">#}
                            {#<div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="60"#}
                            {#aria-valuemin="0" aria-valuemax="100" style="width:60%; text-align: left;" >#}
                            {#&nbsp;<span class="glyphicon glyphicon-star"></span> 5&nbsp;&nbsp;&nbsp;<span class="glyphicon glyphicon-user"></span>12312#}
                            {#</div>#}
                            {#</div>#}

                            {#<div class="progress"  >#}
                            {#<div class="progress-bar " role="progressbar" aria-valuenow="10"#}
                            {#aria-valuemin="0" aria-valuemax="100" style="width:10%; text-align: left;">#}
                            {#&nbsp;<span class="glyphicon glyphicon-star"></span> 5&nbsp;&nbsp;&nbsp;<span class="glyphicon glyphicon-user"></span>6344#}
                            {#</div>#}
                            {#</div>#}

                            {#<div class="progress" >#}
                            {#<div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="50"#}
                            {#aria-valuemin="0" aria-valuemax="100" style="width:25%; text-align: left;">#}
                            {#&nbsp;<span class="glyphicon glyphicon-star"></span> 5&nbsp;&nbsp;&nbsp;<span class="glyphicon glyphicon-user"></span>6344#}
                            {#</div>#}
                            {#</div>#}




                            {#<div class="progress">#}
                            {#<div class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="60"#}
                            {#aria-valuemin="0" aria-valuemax="100" style="width:30%">#}
                            {#60% Complete (warning)#}
                            {#</div>#}
                            {#</div>#}

                            {#<div class="progress">#}
                            {#<div class="progress-bar progress-bar-danger" role="progressbar" aria-valuenow="70"#}
                            {#aria-valuemin="0" aria-valuemax="100" style="width:70%">#}
                            {#70% Complete (danger)#}
                            {#</div>#}
                            {#</div>#}
                            {#</div>#}
                        </div>
                    </div>

                </div>
                <hr>

                <div class="inner-section">



                    <div id="desc_section" class="row inner-box-c" style="background-color: white">
                        {#company description#}
                        {% if company.desc is empty  %}

                            <div  class="container-fluid" style="height: 7vh; align-items: center;display: flex">
                                <h3 style="color: #ccc; margin: auto"> No Description Provided</h3>
                            </div>


                        {% else %}
                            <div id="desc">
                                {{ company.desc| raw }}
                            </div>


                        {% endif %}
                        <hr>
                    </div >




                    {#branch view#}
                    <div id="branch_section" class="row " style="margin:0; " >
                        <div class="row inner-box-c" style="background : transparent">

                            <div class="col-lg-4 col-md-4 col-sm-6 col-xs-6  branch">
                                <div id="accordion">
                                    {% for branch in company.branches %}
                                        {% if branch is not empty %}
                                            <h3 id="{{ branch._id }}"> {{ branch.branchName }}</h3>
                                            <div>
                                                <p>{{ branch.address.street }}, {{ branch.address.city }},
                                                    {% if branch.address.state is defined %}
                                                        {{ branch.address.state }}
                                                    {% endif %}
                                                    {% if branch.address.zipcode is defined %}
                                                        {{ branch.address.zipcode }}
                                                    {% endif %}
                                                    , {{ branch.address.country }}</p>
                                                <p>{{ branch.email }}</p>
                                            </div>

                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-lg-8 col-md-8 col-sm-6 col-xs-6 ">
                                <div id="map"></div>

                            </div>
                        </div>




                    </div>

                    <div id ="comment_section"  class="row inner-box-c">

                        <div class="row no-margin">
                            <div class="col-lg-3 col-md-3 col-sm-4 col-xs-4">
                                <div class="dropdown">

                                    <button class="btn btn-default dropdown-toggle" type="button" id="orderBy" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        Order by
                                        <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">

                                        <li><a href="#"><span class="glyphicon glyphicon-star"></span> Ratings</a></li>
                                        <li><a href="#">&nbsp;&nbsp;&nbsp;Newest</a></li>
                                        <li><a href="#">&nbsp;&nbsp;&nbsp;Oldest</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="container-fluid comment-area">


                        </div>

                        {#<div class="row no-margin" style="display: flex; align-items: center">#}
                            {#<div id="pagination" class="row pagination" style="margin: auto">#}
                            {#</div>#}
                        {#</div>#}
                    </div>
                    {% if is_granted('IS_AUTHENTICATED_FULLY') %}
                        <div class="row">
                            <div class="col-md-6 col-md-offset-3">
                                <div class="form">
                                    <span>Leave a Comment</span>
                                    <div class="row" style="padding-bottom: 20px">
                                        <input id ='rate' min='1' max="5" class='rating-loading'>
                                    </div>
                                    <div class="row">
                                        <form id ="rating_form" style="width: 100%">
                                            <textarea id="text" placeholder="comment" maxlength="250" required></textarea>
                                            <input id='submit' type="submit" value="submit" />
                                        </form>
                                    </div>
                                </div>
                            </div>

                        </div>
                    {% endif %}

                </div>
            </div>

        </div>



        <style>

           .caption span{
                /*background-color: #ccc;*/
                border-radius: 3px;
                font-weight:  normal;
                font-size: 20px;
            }
            .caption{
                margin-top: 0 !important;
            }
            .comment-area{
                border-bottom: 1px solid #ccc;
                border-top: 1px solid #ccc;
                max-height: 50vh;
                overflow: auto;
                margin: 10px 0;
            }

            .no-margin{
                margin: 0;
                padding: 0;
            }

           .progress {
               border: none;
               border-radius: 0;
               margin-bottom: 5px;
            }

           .profile-pic{
               width: 160px;
               height: 160px;
               margin: 25px auto 25px auto;
           }

           .inner-box-c{
               padding: 4%;
               margin:  0;
           }

            #comment_section{
                border-radius: 3px;
                /*border: 1px solid #ccc;*/
            }

            .navbar{
                margin-bottom: 0;
            }


            .inner-section{

                margin: 15px 0;
                background-color: white;
            }
            .section-container {
                -webkit-box-shadow: 0px 0px 17px -2px rgba(0,0,0,0.75);
                -moz-box-shadow: 0px 0px 17px -2px rgba(0,0,0,0.75);
                box-shadow: 0px 0px 17px -2px rgba(0,0,0,0.75);

            }

           .rating span{

               -webkit-text-stroke-width: 0 !important;
           }
           body{
              color: #333;
              /*-webkit-text-fill-color: #fff;*/
              /*-webkit-text-stroke-color: #d78965;*/



              font-family: "Roboto", UILanguageFont, Arial, sans-serif;
              font-size: 17px;
              line-height: 30px;

              background: rgba(226,226,226,1);
              background: -moz-linear-gradient(left, rgba(226,226,226,1) 0%, rgba(219,219,219,1) 34%, rgba(209,209,209,1) 62%, rgba(254,254,254,1) 100%);
              background: -webkit-linear-gradient(left, rgba(226,226,226,1) 0%, rgba(219,219,219,1) 34%, rgba(209,209,209,1) 62%, rgba(254,254,254,1) 100%);
              background: -o-linear-gradient(left, rgba(226,226,226,1) 0%, rgba(219,219,219,1) 34%, rgba(209,209,209,1) 62%, rgba(254,254,254,1) 100%);
              background: -ms-linear-gradient(left, rgba(226,226,226,1) 0%, rgba(219,219,219,1) 34%, rgba(209,209,209,1) 62%, rgba(254,254,254,1) 100%);
              background: linear-gradient(to right, rgba(226,226,226,1) 0%, rgba(219,219,219,1) 34%, rgba(209,209,209,1) 62%, rgba(254,254,254,1) 100%);
              filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#e2e2e2', endColorstr='#fefefe', GradientType=1 );
          }



        </style>


        <style>

            .total-rate{
                font-size:72px;
                color: #aaa
            }

            .user-count{
                color: #aaa
            }

            .form textarea{
                background:#F8F8F8;
                color:#999999;
                border:1px solid #DCDCDC;
                border-radius:2px ;
                font-size:19px ;
                width: 100% ;
                height: 22vh;
                padding: 22px ;
                box-shadow: 0px 0px 8px #DCDCDC;
                -webkit-box-shadow: 0px 0px 8px #DCDCDC;
                -moz-box-shadow: 0px 0px 8px #DCDCDC;

            }

            @media (max-width: 767px) {
                #map {
                    width: 100%;
                    height: 300px;
                    border: 2px solid #333;
                    border-radius: 2px;
                }
            }

            @media (min-width: 767px) {
                #map {
                    width: 100%;
                    height: 500px;
                    border: 2px solid #333;
                    border-radius: 2px;
                }
            }

            .ui-accordion-header{
                background: none; !important;
                background-color: #333; !important;
                color:  #9d9d9d;
            }

            .ui-accordion-header-active{
                background: none; !important;
                background-color: #4caf50; !important;
                color: white;
            }

            .btn-read{

                margin: 20px 5% 0 5%;

            }
            .btn-read .btn{
                border: none;
                width: 90%;
                font-size: 20px;
                font-weight: bold;
                line-height: 30px;
                margin: auto;
                color: #2BB673;

            }

            .btn-read .btn:hover{
               outline: none;
            }


        </style>

        {#overlay styles#}
        <style>


            #loader-c{
                align-content: center;
                align-items: center;
                display:flex;
                width: 100%;
                height: 7vh;
                background : #F8F8F8;
                border-top-left-radius: 6px;
                border-top-right-radius: 6px;
            }
            #overlay {
                background-color: rgba(2, 2, 2, 0.8);
                z-index: 100000;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                display: none;
                align-items: center;
                align-content: center;

            }

            #animate{
                top : 45%;
                left: 47%;
                position: fixed;
                z-index: 110000;
                margin: 0;
                color: white;
            }

        </style>

        {#=================================control the comment submission.================================#}




        <script>

            var page = 1;

            $(document).ready(function(ev){

                $('#desc').readmore({
                    speed: 500,
                    collapsedHeight: 100,
                    lessLink: '<div class="btn-read"><button class="btn btn-default" " href="#">Read Less</button></div>',
                    moreLink: '<div class="btn-read"><button class="btn btn-default" " href="#">Read More</button></div>'
                });


//            =============================generate the rating widgets====================================================



                {% if company.ratingScore is not empty  %}

                    $('.total-rate').html(({{ company.ratingScore }}).toFixed(1))
                    $('#display_rating').val({{ company.ratingScore }}).rating({displayOnly: true, step: 0.1});


                {% else %}

                    $('.total-rate').html('NR')
                    $('#display_rating').val(0).rating({displayOnly: true, step: 0.1});
                    $('#rating-col .user-count').html('<span class="glyphicon glyphicon-user "></span> ' + 0);

                {% endif %}


                var $accordion = $( "#accordion" ).accordion({
                    collapsible: true,
                    active: false,
                });

                {% if is_granted('IS_AUTHENTICATED_FULLY') %}  {#will be added if only the user logged in#}

                    $('#rate').rating({hoverOnClear: false, step: 1});

                {% endif %}

                //====================comment scroll event======================
                scrollHandler();

                //load initial comment set
                page = 1;
                load_more();


            });



            function  scrollHandler(){
                $('.comment-area').on('scroll', function(){
                    if($(this).scrollTop() + $(this).innerHeight()>=$(this)[0].scrollHeight)
                    {
                        $(this).off('scroll');
                        load_more();

                    }
                });
            }



//          =======================control the map===================================================================

            //initiate the map
            var map = new GMaps({
                el: '#map',
            });

            //serialize the branches array from the twig template

            var branches = {{ company.branches|json_encode()|raw }};
            var address = {{ company.address|json_encode()|raw }};
            var bounds = [];

            //add marker for the headoffice
            var hq = [];
            hq['address']= address;
            hq['_id']= '{{ company.id }}';

            var c_name = '{{ company.companyName }}';
            if (branches> 0){
                c_name = c_name + ' HQ';
            }
            hq['branchName'] = c_name;
            branches.push(hq);

            //add markers for each branch
            branches.forEach(function(branch, index){
                //set bounds to define zoom of map

                if (typeof branch.address.latitude === 'undefined' || branch.address.latitude === null ){

                }else{
                    var latlng = new google.maps.LatLng(branch.address.latitude, branch.address.longitude);
                    bounds.push(latlng);

                    map.addMarker({
                        id:branch._id,
                        lat: branch.address.latitude,
                        lng: branch.address.longitude,
                        title: branch.branchName,
                        infoWindow: {
                            content: '<h4>'+branch.branchName+'</h4><div>'+branch.address.city+','+branch.address.country+'</div>',
                            maxWidth: 150
                        },
                        color : 'blue',
                        dblclick : function(e){
                            //implement later
                        }
                    });
                }

            });

            map.fitLatLngBounds(bounds);

            function getBranchSelected(id){
                $accordion.accordion("option","active",$('h3#'+id).getParent());
            }

        </script>






        {#//ajax calls to the server#}
        <script>
//            submit the comment
            $('#rating_form').submit(function(ev){
                ev.preventDefault();

                var animator=$('#animate');
                animator.html('<img style="margin: 0" src="{{ asset('bundles/bd/images/preloader_withbg.gif') }}" />').
                parent().show();

                //get date from the form
                var rate = $('#rate').val();
                var text = $('#text').val();
                $.ajax({
                    type: 'POST',
                    url: '{{ path('rate_company')|raw }}?id={{ company.id }}&rate='+rate+'&text='+text,
                    success: function (data) {



                        if (data.total_score != null && data.count != null && data.count>0) {
                            $('#rating-col .user-count').html('<span class="glyphicon glyphicon-user "></span> ' + data.count);
                            $('#rating-col .total-rate').html(data.total_score.toFixed(1));
                            $('#rating-col #display_rating').val(data.total_score);
                        }else {
                            $('#rating-col .user-count').html('<span class="glyphicon glyphicon-user "></span> ' + 0);
                            $('#rating-col .total-rate').html('Not rated');
                            $('#rating-col #display_rating').val(0);
                        }

                        animator.empty().parent().hide();

                        page = 1;
                        load_more();



                        $("#submit").delay(1000).notify("Thank you for the review",{
                            elementPosition: 'right',
                            className: 'success',
                        });



                    },
                    error: function (e) {

                        animator.empty().parent().hide();

                        $("#submit").delay(1000).notify("We are sorry .The comments can't be submitted. Please try again later",{
                            elementPosition: 'right',
                            className: 'error',
                        });
                        var errors =$.parseJSON(e.responseText).error;
                        console.dir(errors);
                        $(errors).each(function(i,e){
                            errorDiv.append('<p>'+ e.error+'</p>');
                        });


                        errorDiv.fadeIn();
                        alert('error in saving form')
                    },
                });
            })

            //request the ratings
            function load_more(){


                var loader = '<div id ="loader-c"> ' +
                        '<div style="margin: auto"><img  src="{{ asset('bundles/bd/images/preloader-small-o.gif') }}" /></div>' +
                '</div>';

                $('.comment-area').append(loader);


                $.ajax({
                    type: 'POST',
                    url: '{{ path('get_rate')|raw }}?id={{ company.id }}&page='+page,
                    success: function (data) {
                        console.dir(data);
                        var comment_area = $('.comment-area');

                        //check for comment refresh
                        if (page == 1){
                            comment_area.empty();
                        }

                        if (data.length > 0){
                            $('.comment-area #loader-c').remove();

                            $(data).each(function(i,c){
                                var row = $('#comment-row .row-comment').clone();

                                $(row).find('.filled-stars').css('width',c.rate*20+'%');
                                console.dir( $(row).find('.filled-stars'));
                                console.dir(c.rate);
                                $(row).find('cite').html(c.username);
                                $(row).find('a').html(c.timestamp);
                                $(row).find('p').html(c.text);

                                comment_area.append(row).append('<hr>');
                                scrollHandler();

                            });
                        }else{

                            if (page == 1){
                                $('.comment-area #loader-c').html('<h3 style="color : #ccc; margin: auto">Be the first one to review this company</h3>');
                                page--;
                            }
                            $('.comment-area #loader-c').html('<h3 style="color : #ccc; margin: auto">No more</h3>');
                        }
                        page++;
                    },
                    error: function (e) {

                        $('.comment-area #loader-c').html('<h3 style="color : #ccc; margin: auto">No more</h3>');

                        alert('error comments')
                    },
                });
            }



        </script>



        <style>

            /*ol li:nth-of-type(odd){*/
                /*background:#FFFFFF;*/
            /*}*/

            .author{
                width:200px;
                height:100px;
                text-align:center;
            }

            .author img, cite, .author a{
                float:left;
                clear:both;
            }

            cite, .author a{
                width:200px;
                color:#808285;
                font-size:12px;
            }

            cite{
                color:#2BB673;
                font-style:normal;
                font-size:18px;
                cursor:pointer;
            }


            /*li:nth-of-type(even) p{*/
                /*background:#FFFFFF;*/
                /*color:#808285;*/
            /*}*/

            /*li:nth-of-type(even) p:before{*/
                /*border-right:10px solid #FFFFFF;*/
            /*}*/



            ::-webkit-input-placeholder {
                color: #ccc;
            }

            :-moz-placeholder { /* Firefox 18- */
                color: #ccc;
            }

            ::-moz-placeholder {  /* Firefox 19+ */
                color: #ccc;
            }

            :-ms-input-placeholder {
                color: #ccc;
            }

            input[type="submit"]{
                border:none;
                padding:5px 20px;
                color:#FFFFFF;
                background:#E8504F;
                font-size:16px;
                display:block;
                margin-top:5px;
                margin-bottom:5px;
            }

            input[type="submit"]:hover{
                background:#EA625A;
            }

            input[type="submit"]:active{
                background:#FFFFFF;
                color:black;
            }

        </style>
    {% endif %}


    {#use for prototyping comment rows #}
    <div id="comment-row" style="display: none">
        <div class="row row-comment">
            <div class="col-lg-3 col-md-3 col-sm-4 col-sm-6">
                <div class="author">
                    <div class="rating-container rating-xs rating-animate">
                        <div class="rating" style="font-size: 20px">
                                                <span class="empty-stars">
                                                    <span class="star">
                                                        <i class="glyphicon glyphicon-star-empty"></i>
                                                    </span>
                                                    <span class="star">
                                                        <i class="glyphicon glyphicon-star-empty"></i>
                                                    </span>
                                                    <span class="star">
                                                        <i class="glyphicon glyphicon-star-empty"></i>
                                                    </span>
                                                    <span class="star"><i class="glyphicon glyphicon-star-empty"></i>
                                                    </span>
                                                    <span class="star"><i class="glyphicon glyphicon-star-empty"></i>
                                                    </span>
                                                </span>
                                                <span class="filled-stars" style="width: 40%; color: #e52; border-color:#e52 ">
                                                    <span class="star">
                                                        <i class="glyphicon glyphicon-star"></i>
                                                    </span>
                                                    <span class="star">
                                                        <i class="glyphicon glyphicon-star"></i>
                                                    </span>
                                                    <span class="star">
                                                        <i class="glyphicon glyphicon-star"></i>
                                                    </span>
                                                    <span class="star">
                                                        <i class="glyphicon glyphicon-star"></i>
                                                    </span>
                                                    <span class="star">
                                                        <i class="glyphicon glyphicon-star"></i>
                                                    </span>
                                                </span>
                        </div>
                        <input class="display_rating hide" type="text" data-size="xs" >
                    </div>
                    <cite class="user-c">Anonymous</cite>
                    <a class="timestamp"></a>
                </div>
            </div>
            <div class="col-lg-9 col-md-9 col-sm-8 col-sm-6">
                <p class="text-c"></p>

            </div>
        </div>
    </div>







{% endblock %}